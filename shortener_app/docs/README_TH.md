## #gogoth
## สร้าง URL Shortener ด้วย FastAPI และ Python

> _ดัดแปลงจาก_ [https://realpython.com/build-a-python-url-shortener-with-fastapi/](https://realpython.com/build-a-python-url-shortener-with-fastapi/)

**การอัปเดตที่สำคัญ:**

*   **รองรับ Pydantic V2:** ปรับปรุงซอร์สโค้ดให้ทำงานร่วมกับ pydantic เวอร์ชัน 2 ได้อย่างราบรื่น
*   **การตั้งค่าเพิ่มเติม:** เพิ่ม `pydantic-settings` เพื่อให้มีตัวเลือกการกำหนดค่าเพิ่มเติม
*   **คู่มือการย้ายข้อมูล:** สำหรับข้อมูลโดยละเอียดเกี่ยวกับกระบวนการย้ายข้อมูล โปรดดูที่ [https://docs.pydantic.dev/latest/migration/](https://docs.pydantic.dev/latest/migration/)
*   **การแปลงโค้ด:** ซอร์สโค้ดได้รับการแก้ไขโดยใช้ `bump-pydantic` โดยไฟล์ `config.py` เป็นเป้าหมายหลักของการเปลี่ยนแปลง
*   **การรวม Websocket:** รองรับการอัปเดต URL แบบเรียลไทม์ผ่าน websockets
*   **การดึงข้อมูลหน้าเว็บแบบอะซิงโครนัส:** การดึง title และ favicon จาก URL เป้าหมายจะดำเนินการแบบอะซิงโครนัสโดยใช้ `asyncio` และ `aiohttp` เพื่อปรับปรุงการตอบสนอง
*   **การจัดการ API Key:** เพิ่ม endpoint ใหม่สำหรับการลงทะเบียน API key พร้อมกับการตรวจสอบ API key ที่ได้รับการปรับปรุงและการควบคุมการเข้าถึงตามบทบาท
*   **Blacklisting:** ตอนนี้สามารถขึ้นบัญชีดำ URL เพื่อป้องกันไม่ให้มีการย่อเนื้อหาที่ไม่ต้องการ
*   **รองรับ Custom Key:** ผู้ใช้ที่มีสิทธิ์ที่เหมาะสมสามารถสร้าง URL แบบย่อด้วย custom key ได้แล้ว
*   **ข้อมูลผู้ใช้:** เพิ่ม endpoint สำหรับดึงจำนวน URL ที่ย่อและรายการ URL ที่ย่อสำหรับผู้ใช้ที่ระบุ
*   **การจัดการข้อผิดพลาดที่ได้รับการปรับปรุง:** ปรับปรุงการจัดการข้อยกเว้น HTTP และข้อความแสดงข้อผิดพลาดที่ให้ข้อมูล

**การเรียกใช้ Live Server**

คุณมีสองตัวเลือกสำหรับการเปิดตัว live server:

1.  **ใช้ uvicorn:**

    ```bash
    uvicorn shortener_app.main:app --reload
    ```

2.  **ด้วย Python3:**

    ```bash
    python3 -m uvicorn shortener_app.main:app --reload
    ```

### ฟังก์ชันและ Endpoint หลักใน `main.py`

ไฟล์ `main.py` ทำหน้าที่เป็นแกนหลักของ URL shortening API ของคุณ โดยมีฟังก์ชันและ endpoint ที่จำเป็นเพื่อจัดการด้านต่างๆ ของแอปพลิเคชัน นี่คือรายละเอียดของส่วนประกอบสำคัญ:

**ฟังก์ชัน Helper**

*   **`get_admin_info`:** สร้าง URL ที่ใช้งานง่ายสำหรับการจัดการข้อมูลลิงก์ที่ย่อ รวมถึงการสร้าง QR code
*   **ฟังก์ชัน `raise_*`:** กำหนดข้อยกเว้น HTTP แบบกำหนดเองสำหรับสถานการณ์ข้อผิดพลาดทั่วไป เช่น 404 (ไม่พบ), 400 (คำขอไม่ถูกต้อง), 401 (ไม่ได้รับอนุญาต) และอื่นๆ เพื่อปรับปรุงการจัดการข้อผิดพลาดและประสบการณ์ผู้ใช้
*   **`get_db`, `get_api_db`, `get_blacklist_db`:** สร้างการเชื่อมต่อฐานข้อมูลสำหรับข้อมูล URL หลัก, API key และ URL ที่ขึ้นบัญชีดำตามลำดับ เพื่อให้แน่ใจว่ามีการโต้ตอบกับฐานข้อมูลที่เหมาะสม
*   **`verify_jwt_token`, `create_access_token`, `refresh_token`:** ใช้การตรวจสอบสิทธิ์และการจัดการโทเค็นตาม JWT สำหรับการควบคุมการเข้าถึงผู้ใช้อย่างปลอดภัย
*   **`verify_api_key`:** ตรวจสอบ API key กับฐานข้อมูล เพื่อให้แน่ใจว่ามีการประมวลผลเฉพาะคำขอที่ได้รับอนุญาตเท่านั้น
*   **`fetch_page_info`, `fetch_page_info_and_update_sync`, `fetch_page_info_and_update`:** ดึงข้อมูล title และ favicon จาก URL เป้าหมายแบบอะซิงโครนัสโดยใช้ `asyncio` และ `aiohttp` เพื่อปรับปรุงการตอบสนองของแอปพลิเคชัน
*   **`normalize_url`:** ปรับ URL ให้เป็นมาตรฐานโดยจัดการเครื่องหมาย slash ต่อท้ายอย่างสม่ำเสมอ
*   **`generate_qr_code`:** สร้าง QR code สำหรับ URL ที่ย่อ เพื่อปรับปรุงประสบการณ์ผู้ใช้และความสามารถในการแชร์
*   **`custom_openapi`:** ปรับแต่ง OpenAPI schema เพื่อปรับปรุงเอกสารและความชัดเจน

**API Endpoints**

*   **`/`:** endpoint ข้อความต้อนรับง่ายๆ
*   **`/about`:** หน้า HTML ที่ให้ข้อมูลเกี่ยวกับ URL shortener
*   **`/api/register_api_key`:** ลงทะเบียน API key ใหม่ เพื่อเปิดใช้งานการเข้าถึง API อย่างปลอดภัย
*   **`/api/deactivate_api_key`:** ปิดใช้งาน API key เพื่อปิดการเข้าถึงเพิ่มเติม
*   **`/api/refresh_token`:** รีเฟรชโทเค็น JWT สำหรับการตรวจสอบสิทธิ์อย่างต่อเนื่อง
*   **`/capture_screen`:** จับภาพหน้าจอของเว็บไซต์เป้าหมายและจัดเก็บภาพ
*   **`/check-phishing`:** ตรวจสอบว่า URL เป้าหมายเชื่อมโยงกับกิจกรรมฟิชชิ่งหรือไม่
*   **`/preview_url`:** แสดงตัวอย่างของ URL เป้าหมาย รวมถึง title และ favicon
*   **`/{url_key}`:** เปลี่ยนเส้นทางผู้ใช้จาก URL แบบย่อไปยังเป้าหมายดั้งเดิม โดยจัดการข้อผิดพลาดที่อาจเกิดขึ้นอย่างราบรื่น
*   **`/url`:** สร้าง URL แบบย่อใหม่ เลือกที่จะใช้ custom key (สำหรับผู้ใช้ที่ได้รับอนุญาต) และเริ่มงานเบื้องหลังเพื่อดึงข้อมูลหน้า
*   **`/user/url_count`:** ให้ข้อมูลเฉพาะผู้ใช้ เช่น จำนวน URL ที่ย่อ
*   **`/user/urls`:** ดึงรายการ URL แบบย่อที่สร้างโดยผู้ใช้ที่ระบุ
*   **`/user/url/status`:** อัปเดตสถานะของ URL เฉพาะที่ผู้ใช้เป็นเจ้าของ
*   **`/admin/{secret_key}`:** ดึงข้อมูลโดยละเอียดและตัวเลือกการจัดการสำหรับ URL แบบย่อตาม secret key
*   **`/admin/{secret_key}` (DELETE):** ลบ URL แบบย่อตาม secret key
*   **`/ws/url_update/{secret_key}`:** endpoint websocket สำหรับการอัปเดตข้อมูล URL แบบเรียลไทม์

### การนำ title, favicon url เพิ่มในฐานข้อมูล

## ความสัมพันธ์ของ 3 ฟังก์ชัน `fetch_page_info`, `fetch_page_info_and_update_sync`, `fetch_page_info_and_update`

ทั้งสามฟังก์ชันนี้ทำงานร่วมกันเพื่อดึงข้อมูล title และ favicon จาก URL ที่กำหนดให้ และอัปเดตข้อมูลเหล่านี้ลงในฐานข้อมูล โดยมีการแบ่งหน้าที่และการทำงานแบบ asynchronous และ synchronous ดังนี้

1. **`fetch_page_info(url: str)`**

* **หน้าที่:** ดึงข้อมูล title และ favicon จาก URL ที่กำหนดให้
* **ลักษณะการทำงาน:** เป็น asynchronous coroutine ที่ใช้ `aiohttp` ในการส่งคำร้องขอ HTTP และ `BeautifulSoup` ในการ parse HTML เพื่อดึงข้อมูล
* **อินพุต:** URL ของหน้าเว็บที่ต้องการดึงข้อมูล
* **เอาต์พุต:** คืนค่า tuple `(title, favicon_url)` หรือ `(None, None)` หากเกิดข้อผิดพลาด

2. **`fetch_page_info_and_update_sync(db_url: models.URL)`**

* **หน้าที่:** ดึงข้อมูล title และ favicon จาก URL ที่อยู่ในออบเจกต์ `db_url` แล้วอัปเดตข้อมูลเหล่านี้ลงในฐานข้อมูล
* **ลักษณะการทำงาน:** เป็น synchronous function ที่เรียกใช้ `fetch_page_info` แบบ asynchronous ภายใน thread pool เพื่อหลีกเลี่ยงการบล็อก event loop หลัก
* **อินพุต:** ออบเจกต์ `db_url` ที่มีข้อมูล URL ที่ต้องการดึงข้อมูลและอัปเดต
* **เอาต์พุต:** ไม่มีการคืนค่าโดยตรง แต่จะ